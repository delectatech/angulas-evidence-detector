<section class="component-container">
  <div class="card-header row" [ngClass]="{ loading: loading }">
    <div class="col d-flex align-items-center searcher-container">
      <span class="p-input-icon-left ml-auto">
        <i class="pi pi-search"></i>
        <input #searchInput pInputText type="text" [(ngModel)]="searchValue" (input)="establishmentsTable.filterGlobal(searchInput.value, 'contains')" placeholder="Buscar..." />
      </span>
    </div>
    <div class="col d-flex align-items-center">
      <label for="inputSwitch1" class="me-2">Imágenes con fútbol:</label>
      <p-inputSwitch [(ngModel)]="imagesWithFootballChecked" (onChange)="applyFilter()" id="inputSwitch1"></p-inputSwitch>
    </div>
    <div class="col d-flex align-items-center">
      <label for="inputSwitch2" class="me-2">Comentarios sobre fútbol:</label>
      <p-inputSwitch [(ngModel)]="commentsWithFootballChecked" (onChange)="applyFilter()" id="inputSwitch2"></p-inputSwitch>
    </div>
    <div class="col d-flex align-items-center">
      <label for="inputSwitch2" class="me-2">Provincias:</label>
      <p-dropdown
        [options]="provincesOptions"
        [style]="{ width: '100%', flex: 1 }"
        placeholder="Seleccione una provincia"
        optionLabel="name"
        optionValue="uid"
        (onChange)="applyFilter()"
        [filter]="true"
        [(ngModel)]="selectedProvince"
      />
    </div>
    <div class="col align-items-center row">
      <div class="col text-center">
        <span for="rangeSlider">Potencial</span>
      </div>
      <div class="col-md-6" style="display: flex; justify-content: space-between; align-items: center; min-width: 15em; margin-left: 1.25em">
        <span class="mx-1">{{ rangeValues[0] }}%</span>
        <p-slider class="d-block slider" [(ngModel)]="rangeValues" (onSlideEnd)="applyFilter()" [range]="true"></p-slider>
        <span class="mx-1">{{ rangeValues[1] }}%</span>
      </div>
    </div>
    <div class="col d-flex align-items-center" style="max-width: 160px">
      <p-button class="p-button-secondary p-button-full-width" label="Borrar Filtros" [loading]="loading" (onClick)="resetFilter()" iconPos="right"></p-button>
    </div>
    <div class="col filteredTotal d-flex align-items-center">
      <span>Total filtrados: {{ totalRecords | numberFormat }}</span>
    </div>
  </div>
  <p-table
    #establishmentsTable
    (onLazyLoad)="onLazyLoad($event)"
    [lazy]="true"
    [columns]="cols"
    [value]="(establishments$ | async) ?? []"
    [tableStyle]="{ 'min-width': '50rem' }"
    [totalRecords]="totalRecords"
    [paginator]="true"
    [rows]="15"
    [first]="first"
    [showCurrentPageReport]="false"
    [rowsPerPageOptions]="[10, 15, 20, 50]"
    [sortField]="sortField"
    [sortOrder]="sortOrder"
    [loading]="loading"
    locale="es-ES"
    styleClass="p-datatable-striped"
    currentPageReportTemplate="Mostrando de {first} a {last} de {totalRecords} locales"
    loadingIcon="fas fa-futbol animation-bounce-spin"
  >
    <ng-template pTemplate="header">
      <tr>
        <th *ngFor="let col of cols" [pSortableColumn]="col.orderable ? col.field : null" style="min-width: 10rem">
          <div class="flex align-items-center">
            {{ col.header }}
            <p-sortIcon *ngIf="col.orderable" [field]="col.field"></p-sortIcon>
          </div>
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowData>
      <tr>
        <td *ngFor="let col of cols">
          <ng-container [ngSwitch]="col.field">
            <!-- Other Fields -->
            <ng-container *ngSwitchCase="'name'">
              <span class="namePopUp" (click)="redirectDetail(rowData['restaurantUidentifier'])">
                {{ rowData[col.field] }}
                <i class="mx-1 fa-solid fa-arrow-up-right-from-square"></i>
              </span>
            </ng-container>
            <ng-container *ngSwitchCase="'streetAddress'">
              <span [ngClass]="{ namePopUp: rowData['links'].googleUrl || rowData['links'].tripAdvisorUrl }" (click)="redirectDirection(rowData['links'], rowData['restaurantUidentifier'])">
                {{ rowData[col.field] }}
                <i *ngIf="rowData['links'].googleUrl" class="mx-1 fa-regular fa-map"></i>
                <i *ngIf="rowData['links'].tripAdvisorUrl && !rowData['links'].googleUrl" class="fa-solid fa-utensils"></i>
              </span>
            </ng-container>
            <ng-container *ngSwitchCase="'total_images'">
              {{ rowData?.evidences?.images?.soccer_images_count ?? '-' }}
            </ng-container>
            <ng-container *ngSwitchCase="'total_comments'">
              {{ rowData?.evidences?.comments?.soccer_comments_count ?? '-' }}
            </ng-container>
            <!-- Status Field -->
            <ng-container *ngSwitchCase="'status'">
              <p-tag [value]="rowData[col.field] === 'OPERATIONAL' ? 'Abierto' : 'Cerrado'" [severity]="rowData[col.field] === 'OPERATIONAL' ? 'info' : 'danger'" />
            </ng-container>
            <!-- Potential Ratio as Progress Bar -->
            <ng-container *ngSwitchCase="'potential_ratio'">
              <p-progressBar [value]="rowData['potential_ratio_progressBar']" [showValue]="false" />
              <span class="justify-content-center">
                <small>{{ rowData[col.field] }}</small>
              </span>
            </ng-container>
            <!-- Default Case -->
            <ng-container *ngSwitchDefault>
              {{ rowData[col.field] }}
            </ng-container>
          </ng-container>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td [attr.colspan]="cols.length" class="text-center">
          <div style="width: 25vw; margin: 0 auto">
            <p-messages class="my-2" [(value)]="noEstablishmentsFoundMessage[0]" [enableService]="false" [closable]="false" />
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</section>
